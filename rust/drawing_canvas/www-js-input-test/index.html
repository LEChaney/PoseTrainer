<style>
    /* Disable intrinsic user agent direct manipulation behaviors (such as panning or zooming)
    so that all events on the canvas element are given to the application instead. */

    canvas { touch-action: none; }
</style>

<canvas id="drawSurface" width="500px" height="500px" style="border:1px solid black;"></canvas>

<script>
    const canvas = document.getElementById("drawSurface"),
    context = canvas.getContext("2d");
    let eventIdx = 0;
    let lastTimeStamp = 0.0;

    canvas.addEventListener("pointermove", (e)=> {
        if (e.timeStamp <= lastTimeStamp) {
            return;
        }

        if (e.getCoalescedEvents) {
            for (let coalesced_event of e.getCoalescedEvents()) {
                paint(coalesced_event); // Paint all raw/non-coalesced points
            }
        } else {
            paint(e); // Paint the final coalesced point
        }
        eventIdx += 1;
        lastTimeStamp = e.timeStamp;
    });

    function paint(event) {
        if (event.buttons==1) { // Pen Contact
            // deterministic pseudo-random color from event_idx
            function seededRandom(n) {
                // mulberry32-like integer hash -> [0,1)
                let t = (n >>> 0) + 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }

            const hue = Math.floor(seededRandom(event.timeStamp) * 360);
            const sat = 60 + Math.floor(seededRandom(event.timeStamp + 1) * 20); // 60-80%
            const lit = 40 + Math.floor(seededRandom(event.timeStamp + 2) * 20); // 40-60%
            context.fillStyle = 'hsl(' + hue + ',' + sat + '%,' + lit + '%)';
            // add small random jitter so overlapping events are visible
            const jitter = () => (Math.random() - 0.5) * 10; // Â±5px
            context.fillRect(
                event.clientX + jitter(),
                event.clientY,
                5, 5
            );
            //event_idx = (event_idx + 1) % 4;
        }
    }

</script>
